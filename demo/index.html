<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test DigViewer</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://requirejs.org/docs/release/2.2.0/minified/require.js" charset="utf-8"></script>

    <script src="../digviewer.js" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="../digviewer.css">

    <style>
        body {
            margin: 20px;
        }

        #gridContainer {
            background-color: white;
            border: 1px solid #cccccc;
            font-family: "Helvetica Neue", Helvetica, sans-serif;
            height: 1000px;
            overflow: auto;
            text-align: center;
            width: 1500px;
        }

        .rotatedColHeaders text {
            transform: translate(0.3%) rotate(45deg);
            font-size: 0.85em !important;
        }
        .rotatedColHeaders rect {
            transform: translate(3%, 4px) rotate(45deg) scale(0.9);
        }

    </style>
</head>
<body>

<h1>DIGViewer Example</h1>
<h2>Genomics datasets selection</h2>

<div style="float: left;">
    <div id="gridContainer" style="position: relative;"></div>
    <div id="controlsContainer" style="position: relative; text-align: right;">
        Row Ordering:
          <select id="order" onchange="orderRows(this.value);" >
            <option value="row_sort_function_asc" selected="selected">Ascending</option>
            <option value="row_sort_function_desc">Descending</option>
        </select>
        <br>
        Column Ordering:
          <select id="order" onchange="orderColumns(this.value);" >
            <option value="column_sort_function_asc" selected="selected">Ascending</option>
            <option value="column_sort_function_desc">Descending</option>
        </select>
    </div>
</div>
<div id="tableContainer" style="position: relative; float: left; width:400px; margin: 10px;">
    <table class="table small table-striped">
        <thead>
            <tr>
                <th>Experiment name</th>
                <th>Donor</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script charset="utf-8">
    data = null;


    require.config({
        waitSeconds : 2,
        paths : {
            text : 'bower_components/requirejs-plugins/lib/text', //text is required
            json : 'bower_components/requirejs-plugins/src/json' //alias to plugin
        }
    });

    //Load JSONs, and instantiate DIGViewer grid once completed
    require([   'json!assays_ihec.json',
                'json!cell_types_ihec.json',
                'json!data_ihec.json'], function(assays_ihec, cell_types_ihec, data_ihec){


        assays = assays_ihec.assay;
        assay_categories = assays_ihec.assay_category;
        cell_types = cell_types_ihec.cell_type;
        data = data_ihec.dataset;

        //Prepare a dictionary with assay ID as key, and assay object as value
        assayDict = {};
        for (idx in assays) {
            var assay = assays[idx];
            assayDict[assay.id.toString()] = assay;
        }


        //Prepare a dictionary with assay category ID as key, and assay category object as value
        assayCategoryDict = {};
        for (idx in assay_categories) {
            var assay_category = assay_categories[idx];
            assayCategoryDict[assay_category.id.toString()] = assay_category;
        }



        //This is just for example purposes, remove duplicate data objects with the same assay/cell type. Normally, these would be merged/fixed beforehand...
        var removeDupData = {};
        for (idx in data) {
            dataset = data[idx];
            key = dataset.cell_type + "|" + dataset.assay;

            if (!(key in removeDupData)) {
                removeDupData[key] = data[idx];
            }
        }
        var keys = Object.keys(removeDupData);
        var values = keys.map(function(v) { return removeDupData[v]; });
        data = values;



        //Institiate grid object
        digViewer = new DIGViewer(document.getElementById("gridContainer"), {
            row_data_field: "cell_type",
            row_sort_function: sortFunctions.row_sort_function_asc,
            row_label_function: function(d, i) {return d.name;},

            column_data_field: "assay",
            column_sort_function: sortFunctions.column_sort_function_asc,
            column_label_function: function(d, i) {return d.name;},
            column_label_class_function: function(){return "rotatedColHeaders"},

            colorFunction: function(p){ return "red"; },
            onGridSelectionChanged: updateTable,

            cell_data_property: "track",

            column_group_label_function: function(id) { return assayCategoryDict[id].name; },
            y_cat_function: function(id) {assay = assayDict[id.toString()]; return assayCategoryDict[assay.assay_category];},

        });

        //Display grid in its container
        digViewer.drawGrid(data, cell_types, assays, null, assay_categories);

    });

    var sortFunctions = {
        row_sort_function_asc: function(p1, p2) {
            return p1.name.toLowerCase().localeCompare(p2.name.toLowerCase());
        },
        row_sort_function_desc: function(p1, p2) {
            return p2.name.toLowerCase().localeCompare(p1.name.toLowerCase());
        },
        column_sort_function_asc: function(p1, p2) {
            var cmp = p1.assay_category - p2.assay_category;
            if (cmp == 0) {
                return p1.name.toLowerCase().localeCompare(p2.name.toLowerCase());
            }
            return cmp;
        },
        column_sort_function_desc: function(p1, p2) {
            var cmp = p1.assay_category - p2.assay_category;
            if (cmp == 0) {
                return p1.name.toLowerCase().localeCompare(p2.name.toLowerCase());
            }
            return cmp;
        }
    }

    function orderRows(value) {
        digViewer.row_sort_function = sortFunctions[value];
        digViewer.reorderGrid();
    }

    function orderColumns(value) {
        digViewer.column_sort_function = sortFunctions[value];
        digViewer.reorderGrid();
    }


    function updateTable() {
        var allDatasets = [];
        digViewer.getSelectedCells().forEach(function(p) {
            allDatasets = allDatasets.concat(p);
        });
//        allDatasets.sort(function(p1,p2){return p1.name.toLowerCase().localeCompare(p2.name.toLowerCase());})

        var tableBody = d3.select("#tableContainer").select("tbody");
        tableBody.selectAll("tr").remove();
        tableBody.selectAll("tr").data(allDatasets).enter().append("tr").each(function(p){
            var tr = d3.select(this);
            tr.append("td").text(assayDict[p.assay].name);
            tr.append("td").text(p.donorID);
        });
    }

</script>

</body>
</html>