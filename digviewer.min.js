/*DIGViewer 0.1, Copyright 2013-2016 McGill University. Licensed under the LGPL license.*/
var DIGViewer=function(t,a){"use strict";this.a={b:{c:26,d:26},e:{f:140,g:200},h:{f:200,i:200},j:{k:20,l:12},m:1},this.n=0,this.o=[],this.p=a&&a.p||"row",this.q=a&&a.q||function(){},this.r=a&&a.r||new DigViewerLabelDecorator,this.s=a&&a.s||function(){},this.t=a&&a.t||function(){},this.u=[],this.v=[],this.w=a&&a.w||"column",this.x=a&&a.x||function(){},this.y=a&&a.y||new DigViewerLabelDecorator,this.z=a&&a.z||function(){},this.A=a&&a.A||function(){},this.B=a&&a.B||function(){},this.C=a&&a.C||void 0,this.D=[],this.F=a&&a.F||function(){return"#AAA"},"displayBrackets"in a&&(this.a.m=a.m),this.G=a&&a.G||function(){},this.H=a&&a.H||function(){},this.I=a&&a.I||function(){},this.J=a&&a.J||"data",this.K={},this.L=!1,this.M=void 0;var n=this;this.N=t,this.O=d3.select(t),this.P=this.O.append("div");var r,e;this.Q=0,this.R=0,this.S=0,this.T=1,this.U=function(t,a,i,o,s){if(n.K=n.V(t),n.o=a,n.u=i,n.D=o,n.v=s,0===n.K.length)return n.W(),void n.G();n.n=0;var c=d3.scale.linear();c.domain([0,30]),c.range([1,.6]),n.u.length>=n.a.j.k&&(n.n=n.u.length/n.a.j.l-1),n.S=Math.round(n.n),n.T=c(n.S),n.Q=(n.a.b.c-n.n)*n.u.length,n.R=(n.a.b.d-n.n)*n.o.length,r=d3.scale.ordinal().rangeBands([0,n.Q]).domain(n.u.sort(n.z).map(function(t){return t.id})),e=d3.scale.ordinal().rangeBands([0,n.R]).domain(n.o.sort(n.s).map(function(t){return t.id})),n.P.remove(),n.P=n.O.append("div"),n.X(),n.Y(),n.Z(),n.G()},this.$=function(t,a){t._=a,n.H(t,a)},this.aa=function(){n.ca.ba(".cell").classed("active",function(t){return t._===!0})},this.da=function(t){n.$(t,!t._),n.aa(),n.I()},this.ea=function(t){var a=!0;for(var r in n.K[t.id])n.K[t.id].hasOwnProperty(r)&&(n.K[t.id][r]._||(a=!1));var e=!a;for(var i in n.K[t.id])n.K[t.id].hasOwnProperty(i)&&n.$(n.K[t.id][i],e);n.aa(),n.I()},this.fa=function(t){var a=!0;n.ca.ba(".row").each(function(r){"undefined"!=typeof n.K[r.id][t.id]&&(n.K[r.id][t.id]._||(a=!1))});var r=!a;n.ca.ba(".row").each(function(a){"undefined"!=typeof n.K[a.id][t.id]&&n.$(n.K[a.id][t.id],r)}),n.aa(),n.I()},this.ga=function(t){if("undefined"!=typeof n.C){var a=n.u.filter(function(a){return n.C(a.id).id.toString()===t}),r=!0;n.ca.ba(".row").each(function(t){a.forEach(function(a){var e=n.K[t.id][a.id];e._||(r=!1)})});var e=!r;n.ca.ba(".row").each(function(t){a.forEach(function(a){n.$(n.K[t.id][a.id],e)})}),n.aa(),n.I()}},this.ha=function(){d3.values(n.K).forEach(function(t){d3.values(t).forEach(function(t){t._=!1})}),n.aa(),n.I()},this.ba=function(){d3.values(n.K).forEach(function(t){d3.values(t).forEach(function(t){n.$(t,!0)})}),n.aa(),n.I()},this.ia=function(){var t=d3.ba(".cell").filter(function(t){return t._});return t.data()},this.ja=function(){r.domain(n.u.sort(n.z).map(function(t){return t.id})),e.domain(n.o.sort(n.s).map(function(t){return t.id})),d3.ba(".backgroundRow").style("fill","#FFFFFF"),n.ca.ba(".defs_y").remove();var t=n.ca.transition().duration(1e3).ba(".row").delay(function(t){return.5*n.o.indexOf(t)}).attr("transform",function(t){return"translate(0,"+e(t.id)+")"});if(n.ca.transition().duration(1e3).ba(".cell").delay(function(t){return.5*n.u.indexOf(t)}).attr("x",function(t){return r(t[n.w])}),n.ca.transition().duration(1e3).ba(".column").delay(function(t){return.5*n.u.indexOf(t)}).attr("transform",function(t){return"translate("+r(t.id)+")rotate(-90)"}),n.r.ka()>0){for(var a=0;a<n.r.ka();a++)n.la("y",a,0,.35);t.ba(".backgroundRow").style("fill",function(t){var a=n.r.ma(t);return null!==a?"url(#"+a+")":"white"});for(var i=0;i<n.r.ka();i++){var o=n.r.na(i);d3.select("#gradient_y_"+i).select("#stop2").transition().delay(1500).duration(1500).attr("stop-color",o)}}},this.V=function(t){var a={};return t.forEach(function(t){var r=t[n.p],e=t[n.w];if("undefined"==typeof a[r]&&(a[r]={}),"undefined"!=typeof a[r][e])throw Error("Multiple data objects for the same row/column combination.");a[r][e]=t}),a},this.X=function(){n.ca=n.P.append("svg").attr("width",Math.max(n.Q+2*n.a.e.g,n.N.offsetWidth-10)).attr("height",Math.max(n.R+n.a.h.i+10,n.N.offsetHeight-10)).on("mouseup",n.oa).on("mouseleave",n.oa).append("g").attr("transform","translate("+1.2*n.a.e.g+","+n.a.h.i+")");n.ca.append("rect").attr("class","background cell_border").attr("id","gridBackground").attr("width",n.Q).attr("height",n.R).attr("pointer-events","none")},this.Y=function(){var t=n.ca.ba(".row").data(n.o).enter().append("g").attr("class",function(t,a){var r=n.t(t,a);return r+=" row"}).attr("transform",function(t){return"translate(0,"+e(t.id)+")"}).each(n.pa);t.append("line").attr("class","cell_border").attr("x2",n.Q).attr("pointer-events","none"),t.append("rect").attr("x",-200).attr("width",200).attr("height",n.a.b.d-n.n).style("fill","white").attr("class","backgroundRow"),t.append("text").attr("class","rtext").attr("x",-6).attr("y",e.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,a){return n.q(t,a)}).attr("style",function(){return"font-size:"+n.T+"em;"}).attr("title",function(t,a){return n.o[a].name}).on("click",n.ea).on("mouseover",n.qa).on("mouseout",n.ra)},this.Z=function(){var t=n.ca.ba(".column").data(n.u).enter().append("g").attr("class",function(t,a){var r=n.B(t,a);return r+=" column"}).attr("transform",function(t){return"translate("+r(t.id)+")rotate(-90)"});if(t.append("line").attr("class","cell_border").attr("x1",-n.R).attr("pointer-events","none"),"undefined"!=typeof n.v){n.a.m&&n.sa(t);var a=n.v.slice(0);a.sort(function(t,a){return d3.ascending(t.name,a.name)});for(var e=0;e<a.length;e++)n.la("x",a[e].id,1,0),d3.select("#gradient_x_"+a[e].id).select("#stop2").attr("stop-color","#333333")}t.append("rect").attr("width",100).attr("height",n.a.b.d-n.n).style("fill-opacity",function(){return"undefined"==typeof n.C?"0":void 0}).style("fill",function(t,a){if("undefined"==typeof n.C)return"white";var r="gradient_x_"+n.C(n.u[a].id).id;return"url(#"+r+")"}).attr("class","backgroundColumn"),t.append("text").attr("class","ctext").attr("x",6).attr("y",r.rangeBand()/2).attr("text-anchor","start").text(function(t,a){return n.x(t,a)}).attr("style",function(){return"font-size:"+n.T+"em;"}).attr("dy",".42em").on("click",n.fa).on("mouseover",n.ta).on("mouseout",n.ua)},this.pa=function(t){var a=d3.select(this).ba(".cell").data(d3.values(n.K[t.id]).filter(function(t){var a=t[n.J];return"object"==typeof a?a.length:0})).enter().append("svg").attr("class","cell").attr("x",function(a){var e=Object.keys(n.K[t.id]),i=e.find(function(r){return n.K[t.id][r]===a});return r(i)}).on("mouseover",n.va).on("mouseout",n.wa).on("mousedown",n.xa).on("mouseup",n.oa);a.append("rect").attr("width",r.rangeBand()).attr("height",e.rangeBand()).style("fill",function(t){return n.F(t.institution)}),a.append("text").text(function(t){var a=t[n.J].reduce(function(t){return t+1},0);return t.ya=a,a}).attr("x",function(){return r.rangeBand()/2}).attr("y",e.rangeBand()/2).attr("text-anchor","middle").attr("dominant-baseline","central").attr("width",r.rangeBand()).attr("height",e.rangeBand()).attr("style","font-size: "+.8*n.T+"em;").attr("fill","black")},this.sa=function(t){var a=[],e=[];t.each(function(t,i){var o=n.u[i],s=n.C(o.id).id,c=r(t.id);s in a?c<a[s]?a[s]=c:c>e[s]&&(e[s]=c):(a[s]=c,e[s]=c)});var i=(n.a.b.c-n.S)/2,o=13-n.S/2;this.ca.ba(".bracket").data(Object.keys(a)).enter().append("g").each(function(t){var r=n.C(t);n.za(n.ca,e[t]+i+o-2,-80,a[t]-i+o+2,-80),n.Aa(n.ca,a[t],e[t],90,i,n.A(r),t)}),d3.ba(".column_category").on("mouseover",n.Ba).on("mouseout",n.Ca).on("click",n.ga)},this.Ba=function(t){d3.ba("#gradient_x_"+t).select("#stop2").transition().duration(200).attr("stop-opacity",.35)},this.Ca=function(){d3.ba(".defs_x").select("#stop2").transition().duration(400).attr("stop-opacity",0)},this.la=function(t,a,r,e){var i=100*r,o=100*(1-r),s=n.ca.append("svg:defs").attr("class","defs_"+t).append("svg:linearGradient").attr("id","gradient_"+t+"_"+a).attr("x1",i+"%").attr("y1","0%").attr("x2",o+"%").attr("y2","0%").attr("spreadMethod","pad");s.append("svg:stop").attr("id","stop1").attr("offset","0%").attr("stop-color","#FFFFFF").attr("stop-opacity",0),s.append("svg:stop").attr("id","stop2").attr("offset","100%").attr("stop-color","#FFFFFF").attr("stop-opacity",e)},this.va=function(t){d3.ba(".row .rtext").classed("active",function(a){return-1!==d3.values(n.K[a.id]).indexOf(t)}),d3.ba(".column .ctext").classed("active",function(a){for(var r in n.K)if(n.K.hasOwnProperty(r)&&n.K[r][a.id]===t)return!0;return!1}),n.L&&(n.$(t,n.M),n.aa())},this.xa=function(t){n.M=!t._,n.$(t,n.M),n.aa(),n.L=!0},this.wa=function(){d3.ba("text").classed("active",!1)},this.qa=function(t){d3.ba(".row .rtext").classed("active",function(a){return t.id===a.id})},this.ra=function(){d3.ba("text").classed("active",!1)},this.ta=function(t){d3.ba(".column .ctext").classed("active",function(a){return t.id===a.id})},this.ua=function(){d3.ba("text").classed("active",!1)},this.oa=function(){n.L&&(n.L=!1,n.I())},this.za=function(t,a,n,r,e){t.append("path").attr("style","stroke: #999999; stroke-width: 0.5px; fill: none;").attr("d",function(){var t=8,i=.6,o=a-r,s=n-e,c=Math.sqrt(o*o+s*s);o/=c,s/=c;var d=a+i*t*s,u=n-i*t*o,f=a-.25*c*o+(1-i)*t*s,l=n-.25*c*s-(1-i)*t*o,h=a-.5*c*o+t*s,p=n-.5*c*s-t*o,v=r+i*t*s,g=e-i*t*o,m=a-.75*c*o+(1-i)*t*s,y=n-.75*c*s-(1-i)*t*o;return"M "+a+" "+n+" Q "+d+" "+u+" "+f+" "+l+" T "+h+" "+p+" M "+r+" "+e+" Q "+v+" "+g+" "+m+" "+y+" T "+h+" "+p})},this.Aa=function(t,a,n,r,e,i,o){var s=(n-a)/2;t.append("text").data(o).attr("class","column_category").attr("style","fill: #AAAAAA;").attr("x",r).attr("dy",".32em").text(i).attr("transform",function(){return"translate("+(a+s+e)+")rotate(-90)"})},this.W=function(){n.P.remove(),n.P=n.O.append("div"),n.P.attr("style","display:flex; justify-content:center; width:100%; height:100%;"),n.P.append("div").attr("id","noDatasetsMessageDiv").attr("style","align-self: center; font-size: large;").append("span").attr("id","noDatasetsMessageSpan").text("No datasets available for the current settings!")}},DigViewerLabelDecorator=function(){"use strict";this.ka=function(){return 1},this.ma=function(){},this.na=function(){}};
