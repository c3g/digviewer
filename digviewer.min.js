/*DIGViewer 0.1, Copyright 2013-2016 McGill University. Licensed under the LGPL license.*/
var DIGViewer=function(t,a){"use strict";this.a={b:{c:26,d:26},e:{f:140,g:200},h:{f:200,i:200},j:{k:20,l:12},m:1},this.n=0,this.o=[],this.p=a&&a.p||"row",this.q=a&&a.q||function(){},this.r=a&&a.r||new DigViewerLabelDecorator,this.s=a&&a.s||function(){},this.t=a&&a.t||function(){},this.u=[],this.v=[],this.w=a&&a.w||"column",this.x=a&&a.x||function(){},this.y=a&&a.y||new DigViewerLabelDecorator,this.z=a&&a.z||function(){},this.A=a&&a.A||function(){},this.B=a&&a.B||function(){},this.C=a&&a.C||void 0,this.D=[],this.F=a&&a.F||function(){return"#AAA"},"displayBrackets"in a&&(this.a.m=a.m),this.G=a&&a.G||function(){},this.H=a&&a.H||function(){},this.I=a&&a.I||function(){},this.J=a&&a.J||"data",this.K={},this.L=!1,this.M=void 0;var n=this;this.N=t,this.O=d3.select(t),this.P=this.O.append("div");var e,r;this.Q=0,this.R=0,this.S=0,this.T=1,this.U=1,this.V=function(t,a,i,o,s){if(n.K=n.W(t),n.o=a,n.u=i,n.D=o,n.v=s,0===t.length)return n.X(),void n.G();n.n=0;var d=d3.scale.linear();d.domain([0,30]),d.range([1,.6]),n.u.length>=n.a.j.k&&(n.n=n.u.length/n.a.j.l-1),n.S=Math.round(n.n),n.U=d(n.S)*this.T,n.Q=(n.a.b.c-n.n)*n.u.length,n.R=(n.a.b.d-n.n)*n.o.length,e=d3.scale.ordinal().rangeBands([0,n.Q]).domain(n.u.sort(n.z).map(function(t){return t.id})),r=d3.scale.ordinal().rangeBands([0,n.R]).domain(n.o.sort(n.s).map(function(t){return t.id})),n.P.remove(),n.P=n.O.append("div"),n.Y(),n.Z(),n.$(),n.G()},this._=function(t,a){t.aa=a,n.H(t,a)},this.ba=function(){n.da.ca(".cell").classed("active",function(t){return t.aa===!0})},this.ea=function(t){n._(t,!t.aa),n.ba(),n.I()},this.fa=function(t){var a=!0;for(var e in n.K[t.id])n.K[t.id].hasOwnProperty(e)&&(n.K[t.id][e].aa||(a=!1));var r=!a;for(var i in n.K[t.id])n.K[t.id].hasOwnProperty(i)&&n._(n.K[t.id][i],r);n.ba(),n.I()},this.ga=function(t){var a=!0;n.da.ca(".row").each(function(e){"undefined"!=typeof n.K[e.id]&&"undefined"!=typeof n.K[e.id][t.id]&&(n.K[e.id][t.id].aa||(a=!1))});var e=!a;n.da.ca(".row").each(function(a){"undefined"!=typeof n.K[a.id]&&"undefined"!=typeof n.K[a.id][t.id]&&n._(n.K[a.id][t.id],e)}),n.ba(),n.I()},this.ha=function(t){if("undefined"!=typeof n.C){var a=n.u.filter(function(a){return n.C(a.id).id.toString()===t}),e=!0;n.da.ca(".row").each(function(t){a.forEach(function(a){if("undefined"!=typeof n.K[t.id]&&a.id in n.K[t.id]){var r=n.K[t.id][a.id];r.aa||(e=!1)}})});var r=!e;n.da.ca(".row").each(function(t){a.forEach(function(a){"undefined"!=typeof n.K[t.id]&&a.id in n.K[t.id]&&n._(n.K[t.id][a.id],r)})}),n.ba(),n.I()}},this.ia=function(){d3.values(n.K).forEach(function(t){d3.values(t).forEach(function(t){t.aa=!1})}),n.ba(),n.I()},this.ca=function(){d3.values(n.K).forEach(function(t){d3.values(t).forEach(function(t){n._(t,!0)})}),n.ba(),n.I()},this.ja=function(){var t=d3.ca(".cell").filter(function(t){return t.aa});return t.data()},this.ka=function(){e.domain(n.u.sort(n.z).map(function(t){return t.id})),r.domain(n.o.sort(n.s).map(function(t){return t.id})),d3.ca(".backgroundRow").style("fill","#FFFFFF"),n.da.ca(".defs_y").remove();var t=n.da.transition().duration(1e3).ca(".row").delay(function(t){return.5*n.o.indexOf(t)}).attr("transform",function(t){return"translate(0,"+r(t.id)+")"});if(n.da.transition().duration(1e3).ca(".cell").delay(function(t){return.5*n.u.indexOf(t)}).attr("x",function(t){return e(t[n.w])}),n.da.transition().duration(1e3).ca(".column").delay(function(t){return.5*n.u.indexOf(t)}).attr("transform",function(t){return"translate("+e(t.id)+")rotate(-90)"}),n.r.la()>0){for(var a=0;a<n.r.la();a++)n.ma("y",a,0,.35);t.ca(".backgroundRow").style("fill",function(t){var a=n.r.na(t);return null!==a?"url(#"+a+")":"white"});for(var i=0;i<n.r.la();i++){var o=n.r.oa(i);d3.select("#gradient_y_"+i).select("#stop2").transition().delay(1500).duration(1500).attr("stop-color",o)}}},this.W=function(t){var a={};return t.forEach(function(t){var e=t[n.p],r=t[n.w];if("undefined"==typeof a[e]&&(a[e]={}),"undefined"!=typeof a[e][r])throw Error("Multiple data objects for the same row/column combination: row '"+e+"' col '"+r+"'");a[e][r]=t}),a},this.Y=function(){n.da=n.P.append("svg").attr("width",Math.max(n.Q+2*n.a.e.g,n.N.offsetWidth-10)).attr("height",Math.max(n.R+n.a.h.i+10,n.N.offsetHeight-10)).on("mouseup",n.pa).on("mouseleave",n.pa).append("g").attr("transform","translate("+1.2*n.a.e.g+","+n.a.h.i+")"),n.da.append("rect").attr("class","background cell_border").attr("id","gridBackground").attr("width",n.Q).attr("height",n.R).attr("pointer-events","none")},this.Z=function(){var t=n.da.ca(".row").data(n.o).enter().append("g").attr("class",function(t,a){var e=n.t(t,a);return e+=" row"}).attr("transform",function(t){return"translate(0,"+r(t.id)+")"}).each(n.qa);t.append("line").attr("class","cell_border").attr("x2",n.Q).attr("pointer-events","none"),t.append("rect").attr("x",-200).attr("width",200).attr("height",n.a.b.d-n.n).style("fill","white").attr("class","backgroundRow"),t.append("text").attr("class","rtext").attr("x",-6).attr("y",r.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,a){return n.q(t,a)}).attr("style",function(){return"font-size:"+n.U+"em;"}).attr("title",function(t,a){return n.o[a].name}).on("click",n.fa).on("mouseover",n.ra).on("mouseout",n.sa)},this.$=function(){var t=n.da.ca(".column").data(n.u).enter().append("g").attr("class",function(t,a){var e=n.B(t,a);return e+=" column"}).attr("transform",function(t){return"translate("+e(t.id)+")rotate(-90)"});if(t.append("line").attr("class","cell_border").attr("x1",-n.R).attr("pointer-events","none"),"undefined"!=typeof n.v){n.a.m&&n.ta(t);var a=n.v.slice(0);a.sort(function(t,a){return d3.ascending(t.name,a.name)});for(var r=0;r<a.length;r++)n.ma("x",a[r].id,1,0),d3.select("#gradient_x_"+a[r].id).select("#stop2").attr("stop-color","#333333")}t.append("rect").attr("width",100).attr("height",n.a.b.d-n.n).style("fill-opacity",function(){return"undefined"==typeof n.C?"0":void 0}).style("fill",function(t,a){if("undefined"==typeof n.C)return"white";var e="gradient_x_"+n.C(n.u[a].id).id;return"url(#"+e+")"}).attr("class","backgroundColumn"),t.append("text").attr("class","ctext").attr("x",6).attr("y",e.rangeBand()/2).attr("text-anchor","start").text(function(t,a){return n.x(t,a)}).attr("style",function(){return"font-size:"+n.U+"em;"}).attr("dy",".42em").on("click",n.ga).on("mouseover",n.ua).on("mouseout",n.va)},this.qa=function(t){var a=d3.select(this).ca(".cell").data(d3.values(n.K[t.id]).filter(function(t){var a=t[n.J];return"object"==typeof a?a.length:0})).enter().append("svg").attr("class","cell").attr("x",function(a){var r=Object.keys(n.K[t.id]),i=r.find(function(e){return n.K[t.id][e]===a});return e(i)}).on("mouseover",n.wa).on("mouseout",n.xa).on("mousedown",n.ya).on("mouseup",n.pa);a.append("rect").attr("width",e.rangeBand()).attr("height",r.rangeBand()).style("fill",function(t){return n.F(t.institution)}),a.append("text").text(function(t){var a=t[n.J].reduce(function(t){return t+1},0);return t.za=a,a}).attr("x",function(){return e.rangeBand()/2}).attr("y",r.rangeBand()/2).attr("text-anchor","middle").attr("dominant-baseline","central").attr("width",e.rangeBand()).attr("height",r.rangeBand()).attr("style","font-size: "+.8*n.U+"em;").attr("fill","black")},this.ta=function(t){var a=[],r=[];t.each(function(t,i){var o=n.u[i],s=n.C(o.id).id,d=e(t.id);s in a?d<a[s]?a[s]=d:d>r[s]&&(r[s]=d):(a[s]=d,r[s]=d)});var i=(n.a.b.c-n.S)/2,o=13-n.S/2;this.da.ca(".bracket").data(Object.keys(a)).enter().append("g").each(function(t){n.C(t),n.Aa(n.da,r[t]+i+o-2,-80,a[t]-i+o+2,-80),n.Ba(n.da,a[t],r[t],90,i,n.A(t),t)}),d3.ca(".column_category").on("mouseover",n.Ca).on("mouseout",n.Da).on("click",n.ha)},this.Ca=function(t){d3.ca("#gradient_x_"+t).select("#stop2").transition().duration(200).attr("stop-opacity",.35)},this.Da=function(){d3.ca(".defs_x").select("#stop2").transition().duration(400).attr("stop-opacity",0)},this.ma=function(t,a,e,r){var i=100*e,o=100*(1-e),s=n.da.append("svg:defs").attr("class","defs_"+t).append("svg:linearGradient").attr("id","gradient_"+t+"_"+a).attr("x1",i+"%").attr("y1","0%").attr("x2",o+"%").attr("y2","0%").attr("spreadMethod","pad");s.append("svg:stop").attr("id","stop1").attr("offset","0%").attr("stop-color","#FFFFFF").attr("stop-opacity",0),s.append("svg:stop").attr("id","stop2").attr("offset","100%").attr("stop-color","#FFFFFF").attr("stop-opacity",r)},this.wa=function(t){d3.ca(".row .rtext").classed("active",function(a){return-1!==d3.values(n.K[a.id]).indexOf(t)}),d3.ca(".column .ctext").classed("active",function(a){for(var e in n.K)if(n.K.hasOwnProperty(e)&&n.K[e][a.id]===t)return!0;return!1}),n.L&&(n._(t,n.M),n.ba())},this.ya=function(t){n.M=!t.aa,n._(t,n.M),n.ba(),n.L=!0},this.xa=function(){d3.ca("text").classed("active",!1)},this.ra=function(t){d3.ca(".row .rtext").classed("active",function(a){return t.id===a.id})},this.sa=function(){d3.ca("text").classed("active",!1)},this.ua=function(t){d3.ca(".column .ctext").classed("active",function(a){return t.id===a.id})},this.va=function(){d3.ca("text").classed("active",!1)},this.pa=function(){n.L&&(n.L=!1,n.I())},this.Aa=function(t,a,n,e,r){t.append("path").attr("style","stroke: #999999; stroke-width: 0.5px; fill: none;").attr("d",function(){var t=8,i=.6,o=a-e,s=n-r,d=Math.sqrt(o*o+s*s);o/=d,s/=d;var c=a+i*t*s,u=n-i*t*o,f=a-.25*d*o+(1-i)*t*s,l=n-.25*d*s-(1-i)*t*o,h=a-.5*d*o+t*s,p=n-.5*d*s-t*o,v=e+i*t*s,g=r-i*t*o,m=a-.75*d*o+(1-i)*t*s,y=n-.75*d*s-(1-i)*t*o;return"M "+a+" "+n+" Q "+c+" "+u+" "+f+" "+l+" T "+h+" "+p+" M "+e+" "+r+" Q "+v+" "+g+" "+m+" "+y+" T "+h+" "+p})},this.Ba=function(t,a,n,e,r,i,o){var s=(n-a)/2;t.append("text").data(o).attr("class","column_category").attr("style","fill: #AAAAAA;").attr("x",e).attr("dy",".32em").text(i).attr("transform",function(){return"translate("+(a+s+r)+")rotate(-90)"})},this.X=function(){n.P.remove(),n.P=n.O.append("div"),n.P.attr("style","display:flex; justify-content:center; width:100%; height:100%;"),n.P.append("div").attr("id","noDatasetsMessageDiv").attr("style","align-self: center; font-size: large;").append("span").attr("id","noDatasetsMessageSpan").text("No datasets available for the current settings!")}},DigViewerLabelDecorator=function(){"use strict";this.la=function(){return 1},this.na=function(){},this.oa=function(){}};
